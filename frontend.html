<html ng-app="app">
<head>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/mermaid/6.0.0/mermaid.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/6.0.0/mermaid.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.min.js"></script>
  <link href="https://cdn.rawgit.com/novus/nvd3/master/build/nv.d3.css" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>
  <script src="https://cdn.rawgit.com/novus/nvd3/master/build/nv.d3.js"></script>
</head>
<body>

    <div class="mermaid" id="diagram">
    
    </div>

    <script type="text/javascript">document.addEventListener('DOMContentLoaded', function() {
        function render(state) {
            // https://mermaid.js.org/syntax/gitgraph.html
            var vcsContainer = document.getElementById("diagram");

            var str = "gitGraph TB:\n";
            vcsContainer.innerText = str + state.graph;

            // TODO: add state.current
        }
    
        function connectToServer(url) {
            let socket = new WebSocket(url);
    
            socket.onopen = () => {
                webSocketMsgOnce({ endpoint:"fetch", params:"" }).then((msg) => {
                    render(JSON.parse(msg.data))
                });
            }
    
            socket.onmessage = (msg) => render(JSON.parse(msg.data));
    
            socket.onclose = () => {
                console.log("WebSocket closed, retrying in 1 second...");
                setTimeout(() => connectToServer(url), 1000);
            };
    
            socket.onerror = (error) => console.error("WebSocket error:", error);
        }
    
        function webSocketMsgOnce(req) {
            return new Promise((resolve, reject) => {
                let socket = new WebSocket("ws://localhost:8008");
    
                socket.onopen = () => {
                    socket.send(JSON.stringify(req));
                }
    
                socket.onmessage = (e) => {
                    resolve(e);
                    socket.close();
                }
    
                socket.onerror = (e) => {
                    reject(e);
                }
            });
        }
    
        connectToServer("ws://localhost:8008");
    });</script>
</body>
</html>